# 链接

## 什么是链接

将各种代码和数据片段收集并组合成为一个单一文件的过程被称为链接

## 链接发生的时间

1. 编译时
2. 加载时，也就是程序被加载器加载到内存并执行时
3. 运行时，由应用程序来执行

## 目标文件的三种形式

1. 可重定位目标文件
2. 可执行目标文件
3. 共享目标文件

## ELF可重定位目标文件包含的节

1. .text:已编译程序的机器代码
2. .rodata:只读数据
3. .data：已经初始化的全局和静态C变量
4. .bss:未初始化的全局和静态C变量，以及所有被初始化为0的全局或静态变量
5. .symtab:符号表，它存放程序中定义和引用的函数和全局变量的信息
6. .rel.text:一个.text节中位置的列表，党链接器把这个目标文件和其他文件组合时需要修改这些位置
7. .rel.data:被模块引用或定义的所有全局变量的重定位信息
8. .debug:一个调试符号表
9. .line:原始C源程序中的行号和.text节中机器指令之间的映射
10. .strtab：一个字符串表，内容包括.symtab和.debug节中的符号表

## 静态库是什么

可以看做是一堆可重定位目标文件的集合

## 为什么需要静态库

1. 节省主存
2. 方便管理

## 静态库出现之前存在的问题

1. 一堆标准库函数如果全都存放在一个单独的可重定位目标文件中，那么每修改一个单独的函数便要重新编译，并且浪费内存
2. 让编译器可以认识标准库函数，遇到的时候便让翻译为相应的代码，但会给编译器带来负担，使其变得复杂
3. 每个标准库函数都是一个单独的可重定位目标文件，将其放在不同的目录中，但是会给使用者带来负担

## 链接器如何使用静态库解析外部引用

连接器维护一个可重定位目标文件的集合E，一个未解析的符号集合U，一个在前面输入文件中已定义的符号集合D。

## 重定位

合并输入模块，并为每个符号分配运行时地址，分为两步

1. 重定位节和符号定义，链接器将所有相同类型的节合并为同一类型的新的聚合节
2. 重定位节中的符号引用

## 加载

将程序复制到内存并运行的过程叫做加载

## 共享库

共享库是一个目标模块，在运行或加载时，可以加载到任意的内存地址，并和一个在内存中的程序链接起来，这个过程称为动态链接。

## 位置无关代码

共享库加载的位置是不可预计的，所以产生了把共享模块的代码段加载到内存的任何位置而无需链接器修改的需求

## PIC数据引用

编译器生成对全局变量的PIC引用基于一个事实：无论在内存中何处加载一个目标模块，数据段与代码段的距离总是保持不变的

PIC函数调用



